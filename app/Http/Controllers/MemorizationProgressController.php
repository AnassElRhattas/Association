<?php

namespace App\Http\Controllers;

use App\Models\MemorizationProgress;
use App\Models\Student;
use Illuminate\Http\Request;
use Illuminate\Support\Carbon;

class MemorizationProgressController extends Controller
{
    /**
     * Display the create form.
     */
    public function create()
    {
        // Build a displayable full name from first_name + last_name and sort by last then first
        $students = Student::selectRaw("id, CONCAT(first_name, ' ', last_name) AS name")
            ->orderBy('last_name')
            ->orderBy('first_name')
            ->get();

        // Arabic names of the 114 Surahs
        $suras = [
            'الفاتحة','البقرة','آل عمران','النساء','المائدة','الأنعام','الأعراف','الأنفال','التوبة','يونس','هود','يوسف','الرعد','إبراهيم','الحجر','النحل','الإسراء','الكهف','مريم','طه','الأنبياء','الحج','المؤمنون','النور','الفرقان','الشعراء','النمل','القصص','العنكبوت','الروم','لقمان','السجدة','الأحزاب','سبأ','فاطر','يس','الصافات','ص','الزمر','غافر','فصلت','الشورى','الزخرف','الدخان','الجاثية','الأحقاف','محمد','الفتح','الحجرات','ق','الذاريات','الطور','النجم','القمر','الرحمن','الواقعة','الحديد','المجادلة','الحشر','الممتحنة','الصف','الجمعة','المنافقون','التغابن','الطلاق','التحريم','الملك','القلم','الحاقة','المعارج','نوح','الجن','المزمل','المدثر','القيامة','الإنسان','المرسلات','النبأ','النازعات','عبس','التكوير','الإنفطار','المطففين','الإنشقاق','البروج','الطارق','الأعلى','الغاشية','الفجر','البلد','الشمس','الليل','الضحى','الشرح','التين','العلق','القدر','البينة','الزلزلة','العاديات','القارعة','التكاثر','العصر','الهمزة','الفيل','قريش','الماعون','الكوثر','الكافرون','النصر','المسد','الإخلاص','الفلق','الناس'
        ];

        // Paginated recent memorization entries (10 per page)
        $recent = MemorizationProgress::with('student')
            ->orderBy('date', 'desc')
            ->orderBy('id', 'desc')
            ->paginate(10);

        return view('memorization_progress.create', compact('students', 'suras', 'recent'));
    }

    /**
     * Store a new memorization progress record.
     */
    public function store(Request $request)
    {
        // Build in: ensure sura_name is one of our list
        $suras = [
            'الفاتحة','البقرة','آل عمران','النساء','المائدة','الأنعام','الأعراف','الأنفال','التوبة','يونس','هود','يوسف','الرعد','إبراهيم','الحجر','النحل','الإسراء','الكهف','مريم','طه','الأنبياء','الحج','المؤمنون','النور','الفرقان','الشعراء','النمل','القصص','العنكبوت','الروم','لقمان','السجدة','الأحزاب','سبأ','فاطر','يس','الصافات','ص','الزمر','غافر','فصلت','الشورى','الزخرف','الدخان','الجاثية','الأحقاف','محمد','الفتح','الحجرات','ق','الذاريات','الطور','النجم','القمر','الرحمن','الواقعة','الحديد','المجادلة','الحشر','الممتحنة','الصف','الجمعة','المنافقون','التغابن','الطلاق','التحريم','الملك','القلم','الحاقة','المعارج','نوح','الجن','المزمل','المدثر','القيامة','الإنسان','المرسلات','النبأ','النازعات','عبس','التكوير','الإنفطار','المطففين','الإنشقاق','البروج','الطارق','الأعلى','الغاشية','الفجر','البلد','الشمس','الليل','الضحى','الشرح','التين','العلق','القدر','البينة','الزلزلة','العاديات','القارعة','التكاثر','العصر','الهمزة','الفيل','قريش','الماعون','الكوثر','الكافرون','النصر','المسد','الإخلاص','الفلق','الناس'
        ];

        $validated = $request->validate([
            'student_id'   => ['required', 'exists:students,id'],
            'sura_name'    => ['required', 'in:'.implode(',', $suras)],
            'verse_start'  => ['required', 'integer', 'min:1', 'lte:verse_end'],
            'verse_end'    => ['required', 'integer', 'min:1', 'gte:verse_start'],
            'date'         => ['required', 'date'],
            'note'         => ['nullable', 'string', 'max:1000'],
        ], [
            'student_id.required' => 'يرجى اختيار الطالب',
            'student_id.exists'   => 'الطالب غير موجود',
            'sura_name.required'  => 'يرجى اختيار السورة',
            'sura_name.in'        => 'اسم السورة غير صحيح',
            'verse_start.required'=> 'يرجى إدخال الآية الأولى',
            'verse_start.integer' => 'رقم الآية يجب أن يكون عددًا صحيحًا',
            'verse_start.min'     => 'رقم الآية الأولى يجب أن يكون 1 على الأقل',
            'verse_start.lte'     => 'رقم الآية الأولى يجب أن يكون أقل من أو يساوي الآية الأخيرة',
            'verse_end.required'  => 'يرجى إدخال الآية الأخيرة',
            'verse_end.integer'   => 'رقم الآية يجب أن يكون عددًا صحيحًا',
            'verse_end.min'       => 'رقم الآية الأخيرة يجب أن يكون 1 على الأقل',
            'verse_end.gte'       => 'رقم الآية الأخيرة يجب أن يكون أكبر من أو يساوي الآية الأولى',
            'date.required'       => 'يرجى إدخال التاريخ',
            'date.date'           => 'صيغة التاريخ غير صحيحة',
            'note.string'         => 'الملاحظة يجب أن تكون نصًا',
            'note.max'            => 'الملاحظة يجب ألا تتجاوز 1000 حرف',
        ]);

        MemorizationProgress::create($validated);

        return redirect()->back()->with('success', 'تم حفظ التقدم في الحفظ بنجاح ✅');
    }
}